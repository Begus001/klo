name: build
description: "Build the client and server and upload them as artifacts"

inputs:
  upload-artifacts:
    default: 'true'
    description: "If artifacts should be uploaded or not"

runs:
  using: 'composite'
  steps:
    - name: install build deps
      shell: bash
      run: |
        apt update
        apt install -y zip unzip

    - uses: actions/checkout@v6
      with:
        fetch-tags: true
        fetch-depth: 0

    - name: build client
      shell: bash
      working-directory: client
      run: |
        set -x
        node -v
        npm i
        npm run build
        npx web-ext lint -s dist -a . --self-hosted -i sidebar/sidebar.js
        npx web-ext build -s dist -a . -n "klo-client.zip"

    - name: build server
      shell: bash
      working-directory: server
      run: |
        set -x
        npm i
        npm run build
        zip klo-server.zip index.js

    - name: upload client
      if: inputs.upload-artifacts == 'true'
      uses: forgejo/upload-artifact@v4
      with:
        name: klo-client
        path: client/klo-client.zip

    - name: upload server
      if: inputs.upload-artifacts == 'true'
      uses: forgejo/upload-artifact@v4
      with:
        name: klo-server
        path: server/klo-server.zip

